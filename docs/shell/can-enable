#!/bin/bash

###########################################################
#*               can configure tool                      *#
#*     The ownership of this file belongs to Mellow      *#
#*                                                       *#
#*              DO NOT EDIT THIS FILE                    *#
#*                                                       *#
###########################################################


# @file   can-enable
# @author Mellow(Xiaok) (https://github.com/Mellow-3D)
# Created Date: 26-04-2022
# -----
# Last Modified: 27-04-2022
# Modified By: Xiaok
# -----
# @copyright (c) 2022 Mellow


DEVICE=""
BITRATE=500000
TXQUEUELEN=256

if [ $(id -u) != 0 ]
then
    echo "Please execute with root privileges or 'sudo '"
    exit
fi

while getopts ":d:b:t:" opt
do
    case $opt in
        d)
            DEVICE=$OPTARG
        ;;
        b)
            BITRATE=$OPTARG
        ;;
        t)
            TXQUEUELEN=$OPTARG
        ;;
        *)
            echo "Unknown parameter $opt"
            exit
        ;;
        ?)
            echo "Unknown parameter $opt"
            exit
        ;;
    esac
done

if [ "$DEVICE" = "" ]
then
    echo "Parameter d cannot be empty"
    exit
fi

if ip a | grep "$DEVICE": > /dev/null;
then
    echo "Discover devices $DEVICE"
else
    echo "Device not found $DEVICE"
    exit
fi

if ! command -v ifconfig > /dev/null 2>&1; then
    echo "Required packages are missing, ready to install"
    if ! sudo apt install net-tools -y > /dev/null 2>&1; then
        echo "Installation of necessary packages failed :net-tools"
        exit
    fi
fi

sudo ifconfig $DEVICE down
sudo ip link set $DEVICE type can bitrate $BITRATE
sudo ip link set $DEVICE txqueuelen $TXQUEUELEN
sudo ifconfig $DEVICE up

if ip a | grep "pfifo_fast state UP group default qlen $TXQUEUELEN" > /dev/null; then
    echo "$DEVICE is enabled"
else
    echo "Failed to enable $DEVICE"
fi

